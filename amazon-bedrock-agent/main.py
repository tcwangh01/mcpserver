"""
Amazon Bedrock Agent Python ç¯„ä¾‹

æœ¬ç¨‹å¼å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Python å’Œ boto3 SDK é€£æ¥ AWS Bedrock Agentï¼Œ
å¯¦ç¾èˆ‡ AI ä»£ç†çš„äº’å‹•ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
- è¨­å®š AWS æ†‘è­‰å’Œå€åŸŸ
- èª¿ç”¨ Bedrock Agent API
- è™•ç†ä¸²æµå›æ‡‰
- å¯¦ç¾éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„
"""

# ============================================================
# ğŸ“¦ åŒ¯å…¥å¿…è¦çš„å¥—ä»¶
# ============================================================
import boto3    # AWS SDK for Pythonï¼Œç”¨æ–¼èª¿ç”¨ AWS æœå‹™ï¼ˆå¦‚ Bedrockã€S3ã€DynamoDB ç­‰ï¼‰
import uuid     # ç”Ÿæˆå…¨åŸŸå”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆUUIDï¼‰ï¼Œç”¨æ–¼å»ºç«‹ä¸é‡è¤‡çš„ Session ID
import pprint   # ç¾åŒ–åˆ—å° Python è³‡æ–™çµæ§‹ï¼Œæ–¹ä¾¿é™¤éŒ¯å’ŒæŸ¥çœ‹è¤‡é›œçš„è³‡æ–™
import logging  # Python æ¨™æº–æ—¥èªŒæ¨¡çµ„ï¼Œç”¨æ–¼è¨˜éŒ„ç¨‹å¼åŸ·è¡Œéç¨‹ä¸­çš„è³‡è¨Šã€è­¦å‘Šå’ŒéŒ¯èª¤

# ============================================================
# ğŸ”§ è¨­å®šæ—¥èªŒç³»çµ±
# ============================================================
# é…ç½®æ—¥èªŒçš„è¼¸å‡ºæ ¼å¼å’Œè¨˜éŒ„ç­‰ç´š
logging.basicConfig(
    # æ—¥èªŒæ ¼å¼ï¼š[æ™‚é–“] è™•ç†åºID {æª”å: è¡Œè™Ÿ} ç­‰ç´š - è¨Šæ¯
    format="[%(asctime)s] p%(process)s {%(filename)s: %(lineno)d} %(levelname)s - %(message)s",
    # è¨­å®šæœ€ä½è¨˜éŒ„ç­‰ç´šç‚º INFOï¼ˆæœƒè¨˜éŒ„ INFOã€WARNINGã€ERRORã€CRITICALï¼‰
    level=logging.INFO,
)
# å»ºç«‹ä¸€å€‹å°ˆå±¬æ–¼ç•¶å‰æ¨¡çµ„çš„ logger å¯¦ä¾‹
logger = logging.getLogger(__name__)

# ============================================================
# ğŸŒ è¨­å®š AWS å€åŸŸå’Œå®¢æˆ¶ç«¯
# ============================================================
# è¨­å®š AWS å€åŸŸï¼ˆå¿…é ˆèˆ‡ä½ å»ºç«‹ Bedrock Agent çš„å€åŸŸä¸€è‡´ï¼‰
# å¸¸è¦‹å€åŸŸï¼š
#   - "us-east-1"      (ç¾åœ‹æ±éƒ¨ - ç¶­å‰å°¼äº)
#   - "us-west-2"      (ç¾åœ‹è¥¿éƒ¨ - ä¿„å‹’å²¡)
#   - "ap-southeast-2" (äºå¤ª - é›ªæ¢¨)
#   - "ap-northeast-1" (äºå¤ª - æ±äº¬)
region = "ap-southeast-2"  # æ¾³æ´²é›ªæ¢¨å€åŸŸ

# å»ºç«‹ STS (Security Token Service) å®¢æˆ¶ç«¯
# ç”¨é€”ï¼šå–å¾— AWS å¸³è™Ÿè³‡è¨Šï¼Œé©—è­‰èº«ä»½
sts_client = boto3.client("sts", region_name=region)

# å»ºç«‹ Bedrock Agent Runtime å®¢æˆ¶ç«¯
# ç”¨é€”ï¼šé€™æ˜¯èª¿ç”¨ Bedrock Agent çš„ä¸»è¦å®¢æˆ¶ç«¯
#       bedrock-agent-runtime æ˜¯å°ˆé–€ç”¨æ–¼åŸ·è¡Œï¼ˆinvokeï¼‰Agent çš„æœå‹™
bedrock_agent_runtime_client = boto3.client("bedrock-agent-runtime", region_name=region)

# å»ºç«‹ boto3 Sessionï¼ˆåŒ…å« AWS é…ç½®è³‡è¨Šï¼‰
session = boto3.session.Session(region_name=region)

# å–å¾—ç•¶å‰ AWS å¸³è™Ÿ IDï¼ˆç”¨æ–¼ç¢ºèªèº«ä»½å’Œé™¤éŒ¯ï¼‰
account_id = sts_client.get_caller_identity()["Account"]

# é¡¯ç¤ºç•¶å‰è¨­å®šçš„å€åŸŸå’Œå¸³è™Ÿï¼ˆæ–¹ä¾¿ç¢ºèªï¼‰
region, account_id

# ============================================================
# ğŸ¤– Agent èª¿ç”¨å‡½æ•¸
# ============================================================
def invoke_agent_helper(
        query,                   # ä½¿ç”¨è€…çš„æŸ¥è©¢å…§å®¹ï¼ˆå­—ä¸²ï¼‰
        session_id,              # Session IDï¼Œç”¨æ–¼è¿½è¹¤å°è©±ï¼ˆåŒä¸€ Session ID è¦–ç‚ºåŒä¸€å°è©±ï¼‰
        agent_id,                # Bedrock Agent çš„å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆå¾ AWS Console å–å¾—ï¼‰
        alias_id,                # Agent åˆ¥å IDï¼ˆç”¨æ–¼ç‰ˆæœ¬æ§åˆ¶ï¼Œå¾ AWS Console å–å¾—ï¼‰
        enable_trace=False,      # æ˜¯å¦å•Ÿç”¨è¿½è¹¤ï¼ˆé¡¯ç¤º Agent åŸ·è¡Œçš„è©³ç´°éç¨‹ï¼‰
        memory_id=None,          # è¨˜æ†¶é«” IDï¼ˆç”¨æ–¼å¤šè¼ªå°è©±è¨˜æ†¶ï¼Œå¯é¸ï¼‰
        session_state=None,      # Session ç‹€æ…‹ï¼ˆå„²å­˜ä¸Šä¸‹æ–‡è³‡è¨Šï¼Œå¯é¸ï¼‰
        end_session=False,       # æ˜¯å¦çµæŸ Sessionï¼ˆTrue è¡¨ç¤ºçµæŸå°è©±ï¼‰
        show_code_use=False,     # æ˜¯å¦é¡¯ç¤ºç¨‹å¼ç¢¼è§£é‡‹å™¨çš„ä½¿ç”¨æƒ…æ³
):
    """
    èª¿ç”¨ Bedrock Agent çš„æ ¸å¿ƒå‡½æ•¸

    æ­¤å‡½æ•¸å°è£äº†èª¿ç”¨ AWS Bedrock Agent API çš„æ‰€æœ‰é‚è¼¯ï¼Œ
    åŒ…æ‹¬åƒæ•¸æº–å‚™ã€API èª¿ç”¨å’Œå›æ‡‰è™•ç†ã€‚

    åƒæ•¸èªªæ˜ï¼š
        query (str): ä½¿ç”¨è€…è¼¸å…¥çš„æŸ¥è©¢æ–‡å­—
        session_id (str): ç”¨æ–¼è¿½è¹¤å°è©±çš„å”¯ä¸€ ID
        agent_id (str): Bedrock Agent çš„ ID
        alias_id (str): Agent åˆ¥å ID
        enable_trace (bool): æ˜¯å¦å•Ÿç”¨åŸ·è¡Œè¿½è¹¤
        memory_id (str, optional): è¨˜æ†¶é«” ID
        session_state (dict, optional): Session ç‹€æ…‹è³‡æ–™
        end_session (bool): æ˜¯å¦çµæŸç•¶å‰ Session
        show_code_use (bool): æ˜¯å¦é¡¯ç¤ºç¨‹å¼ç¢¼è§£é‡‹å™¨ä½¿ç”¨

    è¿”å›ï¼š
        str: Agent çš„å›æ‡‰æ–‡å­—
    """

    # --------------------------------------------------------
    # ğŸ“‹ åƒæ•¸åˆå§‹åŒ–
    # --------------------------------------------------------
    # å¦‚æœæ²’æœ‰æä¾› session_stateï¼Œåˆå§‹åŒ–ç‚ºç©ºå­—å…¸
    if not session_state:
        session_state = {}

    # --------------------------------------------------------
    # ğŸ”¨ å»ºç«‹ API å‘¼å«åƒæ•¸
    # --------------------------------------------------------
    # å»ºç«‹ä¸€å€‹å­—å…¸åŒ…å«æ‰€æœ‰å¿…è¦çš„ API åƒæ•¸
    # æ³¨æ„ï¼šä½¿ç”¨é§å³°å¼å‘½åï¼ˆcamelCaseï¼‰ç¬¦åˆ AWS API è¦ç¯„
    invoke_params = {
        "inputText": query,                                    # ä½¿ç”¨è€…è¼¸å…¥çš„æŸ¥è©¢æ–‡å­—
        "agentId": agent_id,                                   # Agent çš„å”¯ä¸€è­˜åˆ¥ç¢¼
        "agentAliasId": alias_id,                              # Agent åˆ¥å IDï¼ˆç”¨æ–¼ç‰ˆæœ¬æ§åˆ¶ï¼‰
        "sessionId": session_id,                               # Session IDï¼ˆè¿½è¹¤å°è©±ï¼‰
        "enableTrace": enable_trace | show_code_use,           # å•Ÿç”¨è¿½è¹¤æˆ–ç¨‹å¼ç¢¼é¡¯ç¤ºï¼ˆä½¿ç”¨ä½å…ƒé‹ç®— ORï¼‰
        "endSession": end_session,                             # æ˜¯å¦çµæŸç•¶å‰ Session
        "sessionState": session_state,                         # Session ç‹€æ…‹è³‡æ–™
    }

    # --------------------------------------------------------
    # ğŸ” æ¢ä»¶å¼æ·»åŠ åƒæ•¸
    # --------------------------------------------------------
    # åªæœ‰åœ¨ memory_id ä¸æ˜¯ None æ™‚æ‰åŠ å…¥ memoryId åƒæ•¸
    # åŸå› ï¼šAWS API ä¸æ¥å— None å€¼ä½œç‚ºåƒæ•¸ï¼Œæœƒå°è‡´åƒæ•¸é©—è­‰éŒ¯èª¤
    if memory_id is not None:
        invoke_params["memoryId"] = memory_id

    # --------------------------------------------------------
    # ğŸ“¡ èª¿ç”¨ Agent API
    # --------------------------------------------------------
    # ä½¿ç”¨ **invoke_params å±•é–‹åƒæ•¸å­—å…¸ï¼Œèª¿ç”¨ Bedrock Agent
    agent_response = bedrock_agent_runtime_client.invoke_agent(**invoke_params)

    # --------------------------------------------------------
    # ğŸ”„ è™•ç†å›æ‡‰
    # --------------------------------------------------------
    # å°‡ Agent çš„å›æ‡‰å‚³çµ¦ process_response å‡½æ•¸è™•ç†
    # ä¸¦è¿”å›è™•ç†å¾Œçš„æœ€çµ‚çµæœ
    return process_response(
        agent_response, enable_trace=enable_trace, show_code_use=show_code_use
    )

# ============================================================
# ğŸ”„ è™•ç† Agent å›æ‡‰å‡½æ•¸
# ============================================================
def process_response(resp, enable_trace:bool=False, show_code_use:bool=False):
    """
    è™•ç† Bedrock Agent çš„ä¸²æµå›æ‡‰

    æ­¤å‡½æ•¸è™•ç† Agent è¿”å›çš„äº‹ä»¶ä¸²æµï¼ˆEventStreamï¼‰ï¼Œ
    å¾ä¸­æå– Agent çš„æœ€çµ‚ç­”æ¡ˆå’ŒåŸ·è¡Œè¿½è¹¤è³‡è¨Šã€‚

    åƒæ•¸èªªæ˜ï¼š
        resp (dict): Agent API è¿”å›çš„å›æ‡‰ç‰©ä»¶
        enable_trace (bool): æ˜¯å¦å•Ÿç”¨è¿½è¹¤é¡¯ç¤º
        show_code_use (bool): æ˜¯å¦é¡¯ç¤ºç¨‹å¼ç¢¼è§£é‡‹å™¨ä½¿ç”¨

    è¿”å›ï¼š
        str: Agent çš„æœ€çµ‚å›ç­”æ–‡å­—
    """

    # --------------------------------------------------------
    # ğŸ“Š é¡¯ç¤ºåŸå§‹å›æ‡‰ï¼ˆé™¤éŒ¯ç”¨ï¼‰
    # --------------------------------------------------------
    # å¦‚æœå•Ÿç”¨è¿½è¹¤ï¼Œé¡¯ç¤ºå®Œæ•´çš„åŸå§‹å›æ‡‰ç‰©ä»¶
    if enable_trace:
        logger.info(pprint.pprint(resp))

    # --------------------------------------------------------
    # ğŸ” å–å¾—äº‹ä»¶ä¸²æµ
    # --------------------------------------------------------
    # Agent çš„å›æ‡‰æ˜¯ä¸²æµå½¢å¼ï¼Œéœ€è¦é€å€‹è™•ç†äº‹ä»¶
    event_stream = resp["completion"]

    # --------------------------------------------------------
    # ğŸ”„ è™•ç†äº‹ä»¶ä¸²æµ
    # --------------------------------------------------------
    try:
        # éæ­·æ‰€æœ‰äº‹ä»¶
        for event in event_stream:

            # ------------------------------------------------
            # ğŸ“¦ è™•ç†å›æ‡‰å…§å®¹å¡Šï¼ˆchunkï¼‰
            # ------------------------------------------------
            # "chunk" äº‹ä»¶åŒ…å« Agent çš„å¯¦éš›å›æ‡‰æ–‡å­—
            if "chunk" in event:
                # å–å¾—ä½å…ƒçµ„è³‡æ–™
                data = event["chunk"]["bytes"]

                # å¦‚æœå•Ÿç”¨è¿½è¹¤ï¼Œè¨˜éŒ„æœ€çµ‚ç­”æ¡ˆ
                if enable_trace:
                    logger.info(f"Final answer -> \n{data.decode('utf8')}")

                # å°‡ä½å…ƒçµ„è³‡æ–™è§£ç¢¼ç‚º UTF-8 å­—ä¸²
                agent_answer = data.decode("utf8")

                # è¿”å› Agent çš„æœ€çµ‚ç­”æ¡ˆ
                # æ³¨æ„ï¼šæ”¶åˆ° chunk äº‹ä»¶è¡¨ç¤ºè«‹æ±‚æˆåŠŸå®Œæˆ
                return agent_answer

            # ------------------------------------------------
            # ğŸ” è™•ç†è¿½è¹¤äº‹ä»¶ï¼ˆtraceï¼‰
            # ------------------------------------------------
            # "trace" äº‹ä»¶åŒ…å« Agent åŸ·è¡Œéç¨‹çš„è©³ç´°è³‡è¨Š
            elif "trace" in event:
                # ä½¿ç”¨ str() è€Œä¸æ˜¯ json.dumps() ä¾†é¿å… datetime åºåˆ—åŒ–å•é¡Œ
                # åŸå› ï¼štrace äº‹ä»¶ä¸­å¯èƒ½åŒ…å« datetime ç‰©ä»¶ï¼Œç„¡æ³•ç›´æ¥åºåˆ—åŒ–ç‚º JSON
                trace_str = str(event["trace"])

                # æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç¨‹å¼ç¢¼è§£é‡‹å™¨
                if "codeInterpreterInvocationInput" in trace_str:
                    if show_code_use:
                        print("Invoked code interpreter")

                # å¦‚æœå•Ÿç”¨è¿½è¹¤ï¼Œé¡¯ç¤ºè©³ç´°çš„åŸ·è¡Œéç¨‹
                if enable_trace:
                    logger.info("Trace event:")
                    # ä½¿ç”¨ pprint.pformat æ ¼å¼åŒ–è¼¸å‡ºï¼Œé¿å… JSON åºåˆ—åŒ–å•é¡Œ
                    logger.info(pprint.pformat(event["trace"], indent=2))

            # ------------------------------------------------
            # âŒ è™•ç†æœªé æœŸçš„äº‹ä»¶
            # ------------------------------------------------
            else:
                # å¦‚æœé‡åˆ°æœªçŸ¥çš„äº‹ä»¶é¡å‹ï¼Œæ‹‹å‡ºç•°å¸¸
                raise Exception("unexpected event.", event)

    # --------------------------------------------------------
    # ğŸ›¡ï¸ éŒ¯èª¤è™•ç†
    # --------------------------------------------------------
    except TypeError as e:
        # æ•ç² JSON åºåˆ—åŒ–éŒ¯èª¤ï¼ˆå› ç‚º trace å¯èƒ½åŒ…å« datetime ç‰©ä»¶ï¼‰
        # é€™å€‹éŒ¯èª¤ä¸æœƒä¸­æ–·ç¨‹å¼åŸ·è¡Œï¼Œåªè¨˜éŒ„è­¦å‘Š
        if enable_trace:
            logger.warning(f"JSON serialization error (ignored): {e}")

    except Exception as e:
        # å…¶ä»–ç•°å¸¸æœƒé‡æ–°æ‹‹å‡ºï¼Œè®“èª¿ç”¨è€…è™•ç†
        raise Exception("unexpected event.", e)

# ============================================================
# ğŸš€ ä¸»ç¨‹å¼åŸ·è¡Œ
# ============================================================

# --------------------------------------------------------
# ğŸ“ æº–å‚™æŸ¥è©¢
# --------------------------------------------------------
# å®šç¾©è¦ç™¼é€çµ¦ Agent çš„æŸ¥è©¢å…§å®¹
query = "How are you?"

# ä½¿ç”¨ uuid.uuid1() ç”Ÿæˆå”¯ä¸€çš„ Session ID
# Session ID ç”¨æ–¼è¿½è¹¤å°è©±ï¼Œç›¸åŒ ID çš„è«‹æ±‚æœƒè¢«è¦–ç‚ºåŒä¸€å€‹å°è©±
session_id = str(uuid.uuid1())

# --------------------------------------------------------
# ğŸ“¤ é¡¯ç¤ºè«‹æ±‚è³‡è¨Š
# --------------------------------------------------------
# é¡¯ç¤ºåˆ†éš”ç·šï¼Œè®“çµ‚ç«¯è¼¸å‡ºæ›´æ¸…æ™°
print("=" * 60)
print(f"ğŸ“¤ ç™¼é€æŸ¥è©¢åˆ° Bedrock Agent")
print(f"   æŸ¥è©¢å…§å®¹: {query}")
print(f"   Session ID: {session_id}")
print("=" * 60)

# --------------------------------------------------------
# ğŸ”„ èª¿ç”¨ Agent ä¸¦è™•ç†å›æ‡‰
# --------------------------------------------------------
try:
    # èª¿ç”¨ invoke_agent_helper å‡½æ•¸
    response = invoke_agent_helper(
        query=query,                      # æŸ¥è©¢å…§å®¹
        session_id=session_id,            # Session ID

        # âš ï¸ é‡è¦ï¼šè«‹æ›¿æ›ç‚ºä½ çš„å¯¦éš› Agent ID å’Œ Alias ID
        # å¯ä»¥å¾ AWS Console çš„ Bedrock Agent é é¢å–å¾—
        agent_id="Z1BBRMGWOW",           # Agent IDï¼ˆéœ€è¦æ›¿æ›ï¼‰
        alias_id="7EAWVVVJ0X",           # Alias IDï¼ˆéœ€è¦æ›¿æ›ï¼‰

        # å•Ÿç”¨è¿½è¹¤ï¼Œé¡¯ç¤º Agent åŸ·è¡Œçš„è©³ç´°éç¨‹ï¼ˆæ–¹ä¾¿é™¤éŒ¯å’Œå­¸ç¿’ï¼‰
        enable_trace=True,

        # ä¸ä½¿ç”¨è¨˜æ†¶åŠŸèƒ½ï¼ˆå¤šè¼ªå°è©±è¨˜æ†¶ï¼‰
        # å¦‚æœéœ€è¦ Agent è¨˜ä½ä¹‹å‰çš„å°è©±ï¼Œå¯ä»¥æä¾› memory_id
        memory_id=None,

        # ä¸ä½¿ç”¨ Session ç‹€æ…‹
        # session_state å¯ä»¥ç”¨ä¾†å‚³éé¡å¤–çš„ä¸Šä¸‹æ–‡è³‡è¨Š
        session_state=None,

        # ä¸çµæŸ Sessionï¼ˆä¿æŒ Session é–‹å•Ÿï¼Œå¯ä»¥ç¹¼çºŒå°è©±ï¼‰
        end_session=False,

        # ä¸é¡¯ç¤ºç¨‹å¼ç¢¼è§£é‡‹å™¨ä½¿ç”¨æƒ…æ³
        show_code_use=False,
    )

    # --------------------------------------------------------
    # ğŸ“¥ é¡¯ç¤ºå›æ‡‰çµæœ
    # --------------------------------------------------------
    print("\n" + "=" * 60)
    print("ğŸ“¥ æ”¶åˆ° Agent å›æ‡‰:")
    print("=" * 60)
    print(response)
    print("=" * 60)

# --------------------------------------------------------
# âŒ éŒ¯èª¤è™•ç†
# --------------------------------------------------------
except Exception as e:
    # æ•ç²ä¸¦é¡¯ç¤ºæ‰€æœ‰ç•°å¸¸
    print("\n" + "=" * 60)
    print("âŒ ç™¼ç”ŸéŒ¯èª¤:")
    print("=" * 60)
    print(f"éŒ¯èª¤é¡å‹: {type(e).__name__}")
    print(f"éŒ¯èª¤è¨Šæ¯: {str(e)}")
    print("=" * 60)

    # é¡¯ç¤ºå®Œæ•´çš„å †ç–Šè¿½è¹¤ï¼ˆæ–¹ä¾¿é™¤éŒ¯å’Œå®šä½å•é¡Œï¼‰
    import traceback
    traceback.print_exc()
